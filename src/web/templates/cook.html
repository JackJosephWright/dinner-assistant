{% extends "base.html" %}

{% block title %}Cooking Guide - Meal Planning Assistant{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">
            <i class="fas fa-fire text-orange-600"></i> Cooking Guide
        </h1>
        <p class="mt-2 text-gray-600">
            {% if current_plan %}
            Cook this week's meals or search for new recipes
            {% else %}
            Search for recipes and get step-by-step cooking instructions
            {% endif %}
        </p>
    </div>

    <!-- This Week's Meals Section (always rendered, JS populates client-side) -->
    <div id="mealPlanSection" class="bg-gradient-to-r from-orange-50 to-red-50 rounded-lg shadow-lg p-6 mb-6 {{ '' if current_plan else 'hidden' }}">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold text-gray-900">
                <i class="fas fa-calendar-week text-orange-600"></i> This Week's Meals
            </h2>
            <span id="mealCountBadge" class="text-sm text-gray-600">{{ current_plan.meals|length if current_plan else '0' }} recipes</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="mealCardsGrid">
            {% if current_plan %}
            {% for meal in current_plan.meals %}
            <div onclick="loadRecipe('{{ meal.recipe_id }}')"
                 class="bg-white rounded-lg shadow hover:shadow-xl transition-shadow cursor-pointer p-4 border-2 border-transparent hover:border-orange-400">
                <div class="flex items-start justify-between mb-2">
                    <h3 class="font-semibold text-gray-900 flex-1">{{ meal.recipe_name }}</h3>
                    <span class="ml-2 text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full">
                        {{ meal.meal_date if meal.meal_date else 'Day ' + loop.index|string }}
                    </span>
                </div>
                <div class="text-sm text-gray-600 space-y-1">
                    <div><i class="fas fa-clock text-orange-500"></i> {{ meal.estimated_time }} min</div>
                    {% if meal.cuisine %}
                    <div><i class="fas fa-globe text-orange-500"></i> {{ meal.cuisine }}</div>
                    {% endif %}
                    <div><i class="fas fa-signal text-orange-500"></i> {{ meal.difficulty or 'Medium' }}</div>
                </div>
                <div class="mt-3 text-center">
                    <button class="text-orange-600 hover:text-orange-800 font-medium text-sm">
                        <i class="fas fa-book-open"></i> View Recipe
                    </button>
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>
    </div>

    <!-- Recipe Display and Search -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Recipe Search -->
        <div class="lg:col-span-1">
            <div class="bg-white shadow-lg rounded-lg p-6 sticky top-4">
                <h2 class="text-xl font-semibold mb-4">
                    <i class="fas fa-search"></i> Find New Recipe
                </h2>

                <form id="searchForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Search Keywords
                        </label>
                        <input type="text" id="searchQuery" placeholder="e.g., chicken, pasta" class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Max Cooking Time (minutes)
                        </label>
                        <input type="number" id="maxTime" placeholder="e.g., 45" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>

                    <button type="submit" id="searchButton" class="w-full bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 transition-colors">
                        <i class="fas fa-search"></i> Search Recipes
                    </button>
                </form>

                <div id="searchStatus" class="mt-4 hidden">
                    <div class="flex items-center text-orange-600">
                        <i class="fas fa-spinner spinner mr-2"></i>
                        <span>Searching...</span>
                    </div>
                </div>

                <!-- Search Results -->
                <div id="searchResults" class="mt-6 hidden">
                    <h3 class="font-semibold mb-3">Results:</h3>
                    <div id="resultsList" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Results will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Recipe Display -->
        <div class="lg:col-span-2">
            <div class="bg-white shadow-lg rounded-lg p-6">
                <div id="recipeContainer">
                    <div id="emptyState" class="text-center py-12">
                        <i class="fas fa-book-open text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">
                            {% if current_meals %}
                            Select a Recipe Above
                            {% else %}
                            No Recipe Selected
                            {% endif %}
                        </h3>
                        <p class="text-gray-500">
                            {% if current_meals %}
                            Click on one of this week's meals or search for a new recipe
                            {% else %}
                            Search for a recipe to get started
                            {% endif %}
                        </p>
                    </div>

                    <div id="recipeDetails" class="hidden">
                        <!-- Recipe details will be inserted here -->
                    </div>
                </div>

                <div id="loadingRecipe" class="hidden text-center py-12">
                    <i class="fas fa-spinner spinner text-6xl text-orange-600 mb-4"></i>
                    <p class="text-gray-600">Loading recipe...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}
.spinner {
    animation: spin 1s linear infinite;
}

/* Print styles - only show recipe content */
@media print {
    /* Hide navigation, header, footer */
    nav, header, footer {
        display: none !important;
    }

    /* Hide page header and intro text */
    .px-4.py-6 > .mb-6:first-child {
        display: none !important;
    }

    /* Hide meal cards section */
    #mealPlanSection {
        display: none !important;
    }

    /* Hide search sidebar */
    .lg\\:col-span-1 {
        display: none !important;
    }

    /* Hide loading and empty states */
    #emptyState,
    #loadingRecipe {
        display: none !important;
    }

    /* Hide feedback section and action buttons */
    .bg-gradient-to-r.from-blue-50.to-indigo-50,
    .mt-6.pt-6.border-t-2 {
        display: none !important;
    }

    /* Make recipe container full width */
    .grid.grid-cols-1.lg\\:grid-cols-3 {
        display: block !important;
    }

    .lg\\:col-span-2 {
        width: 100% !important;
        max-width: 100% !important;
    }

    #recipeDetails {
        display: block !important;
    }

    /* Clean up print layout */
    .shadow-lg, .shadow {
        box-shadow: none !important;
    }

    .rounded-lg {
        border-radius: 0 !important;
    }

    body {
        font-size: 12pt;
        line-height: 1.4;
    }

    main {
        padding: 0 !important;
        margin: 0 !important;
    }

    /* Ensure ingredients list prints nicely */
    .bg-green-50 {
        background: #f0f9f0 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    /* Ingredients layout for print */
    #recipeDetails .grid.grid-cols-1.lg\\:grid-cols-3 {
        display: flex !important;
        flex-direction: column !important;
    }

    #recipeDetails .lg\\:col-span-1,
    #recipeDetails .lg\\:col-span-2 {
        display: block !important;
        width: 100% !important;
    }

    /* Page break handling */
    .lg\\:col-span-2 > div {
        page-break-inside: avoid;
    }
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
// Store embedded recipe data from MealPlan (Phase 2: 0-query architecture)
const embeddedRecipes = {};
{% if current_plan %}
{% for meal in current_plan.meals %}
embeddedRecipes[{{ meal.recipe_id }}] = {{ meal.recipe | tojson }};
{% endfor %}
{% endif %}

// Check URL for recipe parameter
const urlParams = new URLSearchParams(window.location.search);
const recipeId = urlParams.get('recipe');
if (recipeId) {
    loadRecipe(recipeId);
}

// Search recipes
document.getElementById('searchForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const button = document.getElementById('searchButton');
    const status = document.getElementById('searchStatus');
    const results = document.getElementById('searchResults');

    button.disabled = true;
    status.classList.remove('hidden');

    try {
        const query = document.getElementById('searchQuery').value;
        const maxTime = document.getElementById('maxTime').value || null;

        const response = await fetch('/api/search-recipes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                query: query,
                max_time: maxTime ? parseInt(maxTime) : null,
                limit: 20,
            }),
        });

        const result = await response.json();

        if (result.success && result.recipes.length > 0) {
            displaySearchResults(result.recipes);
            results.classList.remove('hidden');
        } else {
            alert('No recipes found. Try different search terms.');
        }
    } catch (error) {
        alert('Error searching recipes: ' + error.message);
    } finally {
        button.disabled = false;
        status.classList.add('hidden');
    }
});

function displaySearchResults(recipes) {
    const resultsList = document.getElementById('resultsList');
    resultsList.innerHTML = '';

    recipes.forEach(recipe => {
        const div = document.createElement('div');
        div.className = 'p-3 border border-gray-200 rounded-md hover:bg-gray-50 cursor-pointer transition-colors';
        div.onclick = () => loadRecipe(recipe.id);

        div.innerHTML = `
            <div class="font-medium text-gray-900">${recipe.name}</div>
            <div class="text-xs text-gray-500 mt-1">
                ${recipe.estimated_time ? recipe.estimated_time + ' min' : 'Time varies'} •
                ${recipe.cuisine || 'Various'} •
                ${recipe.difficulty || 'Easy'}
            </div>
        `;

        resultsList.appendChild(div);
    });
}

async function loadRecipe(recipeId) {
    const emptyState = document.getElementById('emptyState');
    const recipeDetails = document.getElementById('recipeDetails');
    const loading = document.getElementById('loadingRecipe');

    emptyState.classList.add('hidden');
    recipeDetails.classList.add('hidden');
    loading.classList.remove('hidden');

    // Scroll to recipe display area
    document.getElementById('recipeContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });

    try {
        // First check if recipe is embedded in MealPlan (0-query architecture)
        if (embeddedRecipes[recipeId]) {
            console.log('Using embedded recipe data (0 queries)');
            const recipeData = embeddedRecipes[recipeId];
            displayRecipe({
                success: true,
                recipe_name: recipeData.name,
                ingredients: recipeData.ingredients_raw || recipeData.ingredients,
                steps: recipeData.steps,
                servings: recipeData.servings,
                estimated_time: recipeData.estimated_time,
                cuisine: recipeData.cuisine,
                difficulty: recipeData.difficulty,
                warnings: recipeData.warnings || [],  // Phase 2: Pass variant warnings
            });
            recipeDetails.classList.remove('hidden');
            loading.classList.add('hidden');
            return;
        }

        // Fallback: Fetch from API (for recipes not in current plan)
        console.log('Recipe not in plan, fetching from API...');
        const response = await fetch(`/api/cook/${recipeId}`);
        const result = await response.json();

        if (result.success) {
            displayRecipe(result);
            recipeDetails.classList.remove('hidden');
        } else {
            alert('Error loading recipe: ' + result.error);
            emptyState.classList.remove('hidden');
        }
    } catch (error) {
        alert('Error loading recipe: ' + error.message);
        emptyState.classList.remove('hidden');
    } finally {
        loading.classList.add('hidden');
    }
}

function displayRecipe(data) {
    const container = document.getElementById('recipeDetails');

    // Format ingredients and steps
    const ingredientsList = data.ingredients.map(ing => `
        <li class="flex items-start py-2 border-b border-gray-100 last:border-0">
            <i class="fas fa-check-circle text-green-600 mt-1 mr-3 flex-shrink-0"></i>
            <span class="text-gray-800">${ing}</span>
        </li>
    `).join('');

    const stepsList = data.steps.map((step, i) => `
        <div class="flex mb-6 last:mb-0">
            <div class="flex-shrink-0 w-10 h-10 bg-orange-600 text-white rounded-full flex items-center justify-center font-bold text-lg">
                ${i + 1}
            </div>
            <div class="ml-4 flex-1">
                <p class="text-gray-800 leading-relaxed">${step}</p>
            </div>
        </div>
    `).join('');

    // Build warnings section if present
    const warningsSection = data.warnings && data.warnings.length > 0 ? `
        <div class="mb-6 bg-amber-50 border border-amber-200 rounded-lg overflow-hidden">
            <button onclick="toggleWarnings()"
                    class="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-amber-100 transition-colors">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-amber-600 mr-3"></i>
                    <span class="font-semibold text-amber-800">
                        Modified Recipe - ${data.warnings.length} ${data.warnings.length === 1 ? 'Note' : 'Notes'}
                    </span>
                </div>
                <i id="warningsChevron" class="fas fa-chevron-down text-amber-600 transition-transform"></i>
            </button>
            <div id="warningsContent" class="px-4 pb-4 border-t border-amber-200">
                <ul class="mt-3 space-y-2">
                    ${data.warnings.map(w => `
                        <li class="flex items-start text-amber-800">
                            <i class="fas fa-info-circle text-amber-500 mt-1 mr-2 flex-shrink-0"></i>
                            <span>${w}</span>
                        </li>
                    `).join('')}
                </ul>
            </div>
        </div>
    ` : '';

    container.innerHTML = `
        <div class="mb-6 pb-4 border-b-2 border-orange-200">
            <h2 class="text-3xl font-bold text-gray-900 mb-3">${data.recipe_name}</h2>
            <div class="flex flex-wrap gap-4 text-sm">
                <span class="inline-flex items-center px-3 py-1 bg-orange-100 text-orange-800 rounded-full">
                    <i class="fas fa-clock mr-2"></i> ${data.estimated_time} min
                </span>
                <span class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full">
                    <i class="fas fa-users mr-2"></i> ${data.servings} servings
                </span>
                ${data.cuisine ? `
                <span class="inline-flex items-center px-3 py-1 bg-purple-100 text-purple-800 rounded-full">
                    <i class="fas fa-globe mr-2"></i> ${data.cuisine}
                </span>
                ` : ''}
                ${data.difficulty ? `
                <span class="inline-flex items-center px-3 py-1 bg-green-100 text-green-800 rounded-full">
                    <i class="fas fa-signal mr-2"></i> ${data.difficulty}
                </span>
                ` : ''}
            </div>
        </div>

        ${warningsSection}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-1">
                <div class="bg-green-50 rounded-lg p-4 sticky top-4">
                    <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-list-ul text-green-600 mr-2"></i> Ingredients
                    </h3>
                    <ul class="space-y-1">
                        ${ingredientsList}
                    </ul>
                </div>
            </div>

            <div class="lg:col-span-2">
                <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-fire text-orange-600 mr-2"></i> Instructions
                </h3>
                <div class="space-y-4">
                    ${stepsList}
                </div>
            </div>
        </div>

        <!-- Meal Feedback Section -->
        <div class="mt-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-2 border-blue-200">
            <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-star text-yellow-500 mr-2"></i> Rate This Meal
            </h3>
            <p class="text-sm text-gray-600 mb-4">Help us learn your preferences! Rate this meal after cooking.</p>

            <div class="space-y-4">
                <!-- Star Rating -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">How was it?</label>
                    <div class="flex items-center gap-2" id="starRating">
                        <button onclick="setRating(1)" class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="1">★</button>
                        <button onclick="setRating(2)" class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="2">★</button>
                        <button onclick="setRating(3)" class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="3">★</button>
                        <button onclick="setRating(4)" class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="4">★</button>
                        <button onclick="setRating(5)" class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="5">★</button>
                        <span id="ratingText" class="ml-3 text-sm font-medium text-gray-700"></span>
                    </div>
                </div>

                <!-- Would Make Again -->
                <div class="flex items-center">
                    <input type="checkbox" id="wouldMakeAgain" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="wouldMakeAgain" class="ml-2 text-sm font-medium text-gray-700">
                        <i class="fas fa-heart text-red-500"></i> I would make this again
                    </label>
                </div>

                <!-- Notes -->
                <div>
                    <label for="mealNotes" class="block text-sm font-medium text-gray-700 mb-2">
                        Notes (modifications, what worked, what didn't)
                    </label>
                    <textarea id="mealNotes" rows="3"
                              class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="e.g., Doubled the garlic, added more veggies, cooked for 5 min longer..."></textarea>
                </div>

                <!-- Servings Actual -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="servingsActual" class="block text-sm font-medium text-gray-700 mb-2">
                            Servings Made
                        </label>
                        <input type="number" id="servingsActual" value="${data.servings}" min="1" max="20"
                               class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="cookingTimeActual" class="block text-sm font-medium text-gray-700 mb-2">
                            Actual Time (min)
                        </label>
                        <input type="number" id="cookingTimeActual" value="${data.estimated_time}" min="1" max="300"
                               class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="pt-4">
                    <button onclick="submitFeedback()"
                            class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors shadow-md hover:shadow-lg">
                        <i class="fas fa-check-circle mr-2"></i> Save Feedback
                    </button>
                    <p class="mt-2 text-xs text-center text-gray-500">
                        Your feedback helps us suggest better meals for you over time
                    </p>
                </div>
            </div>
        </div>

        <div class="mt-6 pt-6 border-t-2 border-gray-200 text-center">
            <button onclick="window.print()" class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 mr-2">
                <i class="fas fa-print"></i> Print Recipe
            </button>
            <button onclick="document.getElementById('emptyState').classList.remove('hidden'); document.getElementById('recipeDetails').classList.add('hidden');"
                    class="px-6 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700">
                <i class="fas fa-arrow-left"></i> Back to Search
            </button>
        </div>
    `;
}

// SSE State Synchronization (cross-tab)
let stateEventSource = null;
let tabId = 'cook_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
let stateStreamReconnectDelay = 1000; // Start with 1 second
let stateStreamReconnectTimer = null;

async function updateMealDisplay() {
    /**
     * Update meal cards dynamically without page reload (like Plan tab).
     * Fetches latest MealPlan and updates embedded recipes + meal cards.
     * Uses meal_plan_id from localStorage (like Shop page).
     */
    const mealPlanId = localStorage.getItem('currentMealPlanId');
    if (!mealPlanId) {
        console.log('No meal plan ID in localStorage, cannot load meals');
        return;
    }

    try {
        console.log('Loading meal plan:', mealPlanId);
        const response = await fetch(`/api/plan/${mealPlanId}`);
        const result = await response.json();

        if (result.success && result.plan) {
            console.log('Updating meal display with', result.plan.meals.length, 'meals');

            // Update embedded recipes store
            for (const meal of result.plan.meals) {
                embeddedRecipes[meal.recipe_id] = meal.recipe;
            }

            // Update meal cards grid
            const grid = document.getElementById('mealCardsGrid');
            if (grid) {
                grid.innerHTML = result.plan.meals.map(meal => `
                    <div onclick="loadRecipe('${meal.recipe_id}')"
                         class="bg-white rounded-lg shadow hover:shadow-xl transition-shadow cursor-pointer p-4 border-2 border-transparent hover:border-orange-400">
                        <div class="flex items-start justify-between mb-2">
                            <h3 class="font-semibold text-gray-900 flex-1">${meal.recipe_name}</h3>
                            <span class="ml-2 text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full">
                                ${meal.meal_date || 'Day'}
                            </span>
                        </div>
                        <div class="text-sm text-gray-600 space-y-1">
                            <div><i class="fas fa-clock text-orange-500"></i> ${meal.estimated_time} min</div>
                            ${meal.cuisine ? `<div><i class="fas fa-globe text-orange-500"></i> ${meal.cuisine}</div>` : ''}
                            <div><i class="fas fa-signal text-orange-500"></i> ${meal.difficulty || 'Medium'}</div>
                        </div>
                        <div class="mt-3 text-center">
                            <button class="text-orange-600 hover:text-orange-800 font-medium text-sm">
                                <i class="fas fa-book-open"></i> View Recipe
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // Show the meal plan section (remove hidden class)
            const section = document.getElementById('mealPlanSection');
            if (section) {
                section.classList.remove('hidden');
            }

            // Update recipe count
            const countElement = document.getElementById('mealCountBadge');
            if (countElement) {
                countElement.textContent = `${result.plan.meals.length} recipes`;
            }
        }
    } catch (error) {
        console.error('Error updating meal display:', error);
        // Fallback to page reload on error
        window.location.reload();
    }
}

function startStateStream() {
    // Close existing stream if any
    if (stateEventSource) {
        stateEventSource.close();
    }

    // Clear any pending reconnect
    if (stateStreamReconnectTimer) {
        clearTimeout(stateStreamReconnectTimer);
        stateStreamReconnectTimer = null;
    }

    // Create new SSE connection for state changes
    stateEventSource = new EventSource(`/api/state-stream?tab_id=${tabId}`);

    stateEventSource.onopen = () => {
        console.log('State stream connected');
        stateStreamReconnectDelay = 1000; // Reset delay on successful connection
    };

    stateEventSource.onmessage = (event) => {
        const update = JSON.parse(event.data);

        if (update.type === 'meal_plan_changed') {
            console.log('Meal plan changed, updating meal display...');
            // Dynamic update without page reload (like Plan tab)
            updateMealDisplay();
        }
        // Ignore shopping_list_changed (not relevant to cook tab)
        // Ignore keepalive messages
    };

    stateEventSource.onerror = (error) => {
        console.error('State stream error, will reconnect in', stateStreamReconnectDelay/1000, 'seconds');
        stateEventSource.close();
        stateEventSource = null;

        // Auto-reconnect with exponential backoff (max 30 seconds)
        stateStreamReconnectTimer = setTimeout(() => {
            startStateStream();
        }, stateStreamReconnectDelay);
        stateStreamReconnectDelay = Math.min(stateStreamReconnectDelay * 2, 30000);
    };
}

// Toggle Warnings Section (Phase 2 - Recipe Variants)
function toggleWarnings() {
    const content = document.getElementById('warningsContent');
    const chevron = document.getElementById('warningsChevron');

    if (content && chevron) {
        content.classList.toggle('hidden');
        chevron.classList.toggle('rotate-180');
    }
}

// Meal Feedback Functions
let currentRecipeId = null;
let currentRecipeDate = null;
let selectedRating = 0;

function setRating(rating) {
    selectedRating = rating;
    const stars = document.querySelectorAll('.star-btn');
    const ratingText = document.getElementById('ratingText');

    // Update star colors
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.remove('text-gray-300');
            star.classList.add('text-yellow-400');
        } else {
            star.classList.remove('text-yellow-400');
            star.classList.add('text-gray-300');
        }
    });

    // Update rating text
    const labels = ['', 'Poor', 'Fair', 'Good', 'Great', 'Excellent'];
    ratingText.textContent = labels[rating];
}

async function submitFeedback() {
    // Get form values
    const rating = selectedRating;
    const wouldMakeAgain = document.getElementById('wouldMakeAgain').checked;
    const notes = document.getElementById('mealNotes').value;
    const servingsActual = parseInt(document.getElementById('servingsActual').value) || null;
    const cookingTimeActual = parseInt(document.getElementById('cookingTimeActual').value) || null;

    // Find the meal date for the current recipe
    // Look through embedded recipes to find which meal this is
    let mealDate = null;
    {% if current_plan %}
    {% for meal in current_plan.meals %}
    if (currentRecipeId === '{{ meal.recipe_id }}') {
        mealDate = '{{ meal.date }}';
    }
    {% endfor %}
    {% endif %}

    if (!mealDate) {
        // If not in current plan, we can't save feedback (need a date)
        alert('This recipe is not in your current meal plan. Feedback can only be saved for planned meals.');
        return;
    }

    try {
        const response = await fetch('/api/meal-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                date: mealDate,
                meal_type: 'dinner',
                user_rating: rating > 0 ? rating : null,
                would_make_again: wouldMakeAgain,
                notes: notes || null,
                servings_actual: servingsActual,
                cooking_time_actual: cookingTimeActual
            })
        });

        const result = await response.json();

        if (result.success) {
            alert('✓ Feedback saved! This helps us learn your preferences and suggest better meals for you.');
            // Reset form
            setRating(0);
            document.getElementById('wouldMakeAgain').checked = false;
            document.getElementById('mealNotes').value = '';
        } else {
            alert('Error saving feedback: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error saving feedback: ' + error.message);
    }
}

// Update currentRecipeId when recipe is loaded
const originalLoadRecipe = loadRecipe;
loadRecipe = async function(recipeId) {
    currentRecipeId = recipeId;
    await originalLoadRecipe(recipeId);
};

// Start SSE listener and load meal plan on page load
startStateStream();
updateMealDisplay();
</script>
{% endblock %}
